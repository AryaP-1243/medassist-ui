<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ü©∫ MedAssist - Global Health AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body { margin:0; padding:20px; font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #6a11cb, #2575fc, #ec008c, #fc6767); background-size:400% 400%; animation:gradientBG 18s ease infinite; display:flex; flex-direction:column; align-items:center; min-height:100vh; box-sizing:border-box; color:#343a40;}
    @keyframes gradientBG{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
    .container{background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);padding:40px;border-radius:24px;box-shadow:0 16px 40px rgba(0,0,0,0.15);width:95%;max-width:800px;display:flex;flex-direction:column;gap:20px; margin-left:80px;}
    h1{ text-align:center;font-size:2.8em;font-weight:700;background:linear-gradient(45deg,#0d47a1,#1976d2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .type-selection{display:flex;gap:15px;justify-content:center;}
    .type-button{flex:1;padding:12px 20px;font-size:16px;font-weight:600;background:#e9ecef;color:#555;border:none;border-radius:12px;cursor:pointer;transition:all 0.3s ease;}
    .type-button.active[data-type="medicine"]{background:#e91e63;color:white;}
    .type-button.active[data-type="symptom"]{background:#03a9f4;color:white;}
    .button-group{display:flex;gap:20px;margin-top:10px;}
    button{flex:1;padding:15px;font-size:17px;font-weight:600;background:linear-gradient(90deg,#1e3a8a,#3b82f6);color:white;border:none;border-radius:14px;cursor:pointer;transition:transform 0.2s ease;}
    #output{margin-top:20px;background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 25px rgba(0,0,0,0.08);line-height:1.8;color:#333;max-height:400px;overflow-y:auto;}
    #sidebar{position:fixed;left:20px;top:20px;background:#fff;padding:20px;border-radius:16px;width:240px;max-height:calc(100vh - 40px);overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,0.15);}
    #sidebar h3{margin-top:0;}
    footer{margin-top:30px;text-align:center;color:white;font-size:0.9em;}
  </style>
</head>
<body>

<div id="sidebar">
  <h3><i class="fa-solid fa-clock-rotate-left"></i> History</h3>
  <div id="history">Your previous queries will appear here.</div>
  <hr>
  <strong><i class="fa-solid fa-user"></i> User:</strong> <span id="userDisplay">Not logged in</span>
</div>

<div class="container">
  <h1><i class="fa-solid fa-heart-pulse"></i> MedAssist</h1>

  <input id="emailInput" placeholder="Enter your Email">
  <button onclick="sendMagicLink()">Login via Email Link</button> <div id="healthScore"></div>

  <textarea id="input" placeholder="e.g., Tell me about Aspirin or I have a fever"></textarea>
  <div class="type-selection">
    <button class="type-button active" data-type="medicine" onclick="setType('medicine')"><i class="fa-solid fa-pills"></i> Medicine</button>
    <button class="type-button" data-type="symptom" onclick="setType('symptom')"><i class="fa-solid fa-stethoscope"></i> Symptom</button>
  </div>
  <div class="button-group">
    <button onclick="ask()">Get Insights</button>
    <button onclick="startVoice()">Voice Input</button>
  </div>

  <div id="output">Your insights will appear here üìù</div>
</div>

<footer>&copy; 2025 MedAssist | Built with ‚ù§Ô∏è</footer>

<script>
// Backend URL
const BACKEND_URL = "https://medassist-backend-jp57.onrender.com"; // Ensure this is correct
let currentType = 'medicine';
let userUID = '';

const firebaseConfig = {
    apiKey: "AIzaSyADVw6wELYIyCaG__LkszEbRkSwVnsjv8o",
    authDomain: "medassist-97bc6.firebaseapp.com",
    projectId: "medassist-97bc6",
    storageBucket: "medassist-97bc6.appspot.com",
    messagingSenderId: "456589111482",
    appId: "1:456589111482:web:e951fe2ef7bb84d17a1283"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

function confettiBlast() {
    confetti({particleCount: 150, spread: 90, origin: { y: 0.6 }});
}

function setType(t) {
    currentType = t;
    document.querySelectorAll('.type-button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.type-button[data-type='${t}']`).classList.add('active');
}

function sendMagicLink() {
    const email = document.getElementById("emailInput").value.trim();
    if (!email) {
        alert("Please enter your email address.");
        return;
    }

    const actionCodeSettings = {
        url: window.location.href, // This URL should be whitelisted in Firebase Auth settings
        handleCodeInApp: true
    };

    auth.sendSignInLinkToEmail(email, actionCodeSettings)
        .then(() => {
            window.localStorage.setItem('emailForSignIn', email);
            alert("‚úÖ A login link has been sent to your email! Please check your inbox and click the link to sign in.");
        })
        .catch(e => {
            console.error("Error sending magic link:", e);
            alert(`Error sending login link: ${e.message}`);
        });
}

// Function to fetch and update history
async function fetchAndDisplayHistory(uid) {
    try {
        const response = await fetch(`${BACKEND_URL}/get-history`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ uid: uid })
        });
        const data = await response.json();
        updateHistory(data.history);
    } catch (error) {
        console.error("Error fetching history:", error);
        // alert("Failed to load history."); // Uncomment for user feedback
    }
}

window.onload = function() {
    // Check if a user is already signed in (e.g., from a previous session)
    auth.onAuthStateChanged(user => {
        if (user) {
            userUID = user.uid;
            document.getElementById("userDisplay").innerText = user.email || "Logged in";
            // Immediately fetch and display history for already logged-in users
            fetchAndDisplayHistory(userUID);

            // Optionally, fetch health score if it's already stored
            // You might need a /get-health-score endpoint for this
        }
    });


    if (auth.isSignInWithEmailLink(window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) {
            // Prompt user for email if they opened the link in a different browser/device
            email = prompt("Please enter your email address to complete login:");
            if (!email) {
                alert("Email is required to complete login.");
                window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                return;
            }
        }

        auth.signInWithEmailLink(email, window.location.href)
            .then(result => {
                userUID = result.user.uid;
                document.getElementById("userDisplay").innerText = result.user.email;
                window.localStorage.removeItem('emailForSignIn'); // Clean up localStorage
                window.history.replaceState({}, document.title, window.location.pathname); // Clean up URL

                // After successful login, prompt for food history and save user data
                const food = prompt("Welcome! What did you eat in the last 2-3 days? (For Health Score)");
                if (!food) {
                    alert("Food input is recommended for health score calculation.");
                    // Continue without food if user cancels, but note the missing data
                    return;
                }

                // Call the /save-user endpoint (which also calculates health score)
                fetch(`${BACKEND_URL}/save-user`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ uid: userUID, food_history: food })
                })
                .then(r => r.json())
                .then(data => {
                    document.getElementById("healthScore").innerHTML = `<b>Your Health Score: ${data.health_score}/100</b>`;
                    if (data.health_score >= 80) {
                        confettiBlast();
                    } else {
                        alert("‚ö†Ô∏è Your score is low! Reduce junk food and eat more healthy items like fruits, vegetables, and grilled options.");
                    }
                    // Fetch and display history after successful login and save
                    fetchAndDisplayHistory(userUID);
                })
                .catch(error => {
                    console.error("Error saving user data/calculating score:", error);
                    alert("Failed to save food history or calculate health score.");
                });

            })
            .catch(e => {
                console.error("Error signing in with email link:", e);
                alert(`Error completing login: ${e.message}`);
                window.history.replaceState({}, document.title, window.location.pathname); // Clean URL on error
            });
    }
}


function ask() {
    if (!userUID) {
        alert("Please login first to use MedAssist!");
        return;
    }

    const query = document.getElementById("input").value.trim();
    if (!query) {
        alert("Please enter your query first!");
        return;
    }

    document.getElementById("output").innerHTML = "‚è≥ Generating...";

    fetch(`${BACKEND_URL}/ask`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: query, type: currentType, uid: userUID })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("output").innerHTML = marked.parse(data.response);
        // After a new query, update the history in the sidebar
        fetchAndDisplayHistory(userUID);
    })
    .catch(error => {
        console.error("Error asking question:", error);
        document.getElementById("output").innerHTML = "Error generating response. Please try again.";
    });
}

function updateHistory(h) {
    const sidebar = document.getElementById("history");
    sidebar.innerHTML = "";
    if (h.length === 0) {
        sidebar.innerHTML = "No history yet.";
        return;
    }
    h.forEach(item => {
        const p = document.createElement('p');
        p.className = 'history-item'; // Add a class for potential styling
        p.innerHTML = `${item.type === "medicine" ? "üíä" : "ü©∫"} ${item.message}`;
        p.onclick = () => {
            document.getElementById('input').value = item.message;
            setType(item.type); // Set the type based on history item
            ask();
        };
        sidebar.appendChild(p);
    });
}

function startVoice() {
    // Check for browser compatibility
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
        alert("Sorry, your browser doesn't support Voice Input. Please use a modern browser like Chrome or Edge.");
        return;
    }

    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = "en-IN";
    rec.interimResults = false; // Only return final results
    rec.maxAlternatives = 1; // Only return the most likely result

    rec.onstart = () => {
        document.getElementById("input").placeholder = "Listening...";
        console.log("Voice recognition started.");
    };

    rec.onresult = e => {
        const transcript = e.results[0][0].transcript;
        document.getElementById("input").value = transcript;
        document.getElementById("input").placeholder = "e.g., Tell me about Aspirin or I have a fever";
        ask(); // Automatically ask after voice input
    };

    rec.onerror = e => {
        console.error("Speech recognition error:", e);
        document.getElementById("input").placeholder = "e.g., Tell me about Aspirin or I have a fever";
        alert(`Voice input error: ${e.error}`);
    };

    rec.onend = () => {
        document.getElementById("input").placeholder = "e.g., Tell me about Aspirin or I have a fever";
        console.log("Voice recognition ended.");
    };

    rec.start();
}
</script>

</body>
</html>
