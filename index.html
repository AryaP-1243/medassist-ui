<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>🩺 MedAssist - Global Health AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #6a11cb, #2575fc, #ec008c, #fc6767);
            background-size: 400% 400%;
            animation: gradientBG 18s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #343a40;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            width: 95%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(45deg, #0d47a1, #1976d2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .type-selection { display: flex; gap: 10px; justify-content: center; }
        .type-button {
            flex: 1;
            padding: 10px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            transition: 0.3s;
            color: white;
        }
        .type-button[data-type="medicine"] { background: #e91e63; }
        .type-button[data-type="symptom"] { background: #03a9f4; }
        .type-button.active { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        #output, #history {
            background: #fff;
            padding: 20px;
            border-radius: 14px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #history p { margin: 8px 0; cursor: pointer; }
        #history p:hover { text-decoration: underline; }

        .button-group button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            background: linear-gradient(90deg, #1e3a8a, #3b82f6);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        footer {
            margin-top: 20px;
            text-align: center;
            color: #fff;
            font-size: 0.85em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-heart-pulse"></i> MedAssist</h1>

    <div id="login">
        <input id="contact" placeholder="Enter email or phone" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;margin-bottom:10px;">
        <button onclick="sendOTP()">Send OTP</button>
        <input id="otp" placeholder="Enter OTP" style="width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;margin-top:10px;">
        <textarea id="food" placeholder="What did you eat in the last 3 days?" style="width:100%;margin-top:10px;height:60px;"></textarea>
        <button onclick="verifyOTP()">Verify & Start</button>
    </div>

    <div id="main" style="display:none;">
        <div class="type-selection">
            <button class="type-button active" data-type="medicine" onclick="setType('medicine')">Medicine</button>
            <button class="type-button" data-type="symptom" onclick="setType('symptom')">Symptom</button>
        </div>

        <textarea id="input" placeholder="Ask about a medicine or symptom..." style="width:100%;padding:10px;border-radius:10px;"></textarea>
        <div class="button-group" style="display:flex;gap:10px;margin-top:10px;">
            <button onclick="ask()">Get Insights</button>
            <button onclick="startVoiceInput()">Voice Input</button>
        </div>

        <h3>Previous Queries</h3>
        <div id="history">No previous history.</div>

        <h3>Response</h3>
        <div id="output">Your health insights will appear here.</div>
    </div>
</div>

<footer>© 2025 MedAssist | Global Healthcare AI</footer>

<script>
const BACKEND_URL = "https://medassist-backend-jp57.onrender.com";
let contact = "";
let type = "medicine";

function setType(t) {
    type = t;
    document.querySelectorAll('.type-button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.type-button[data-type="${t}"]`).classList.add('active');
}

function sendOTP() {
    contact = document.getElementById("contact").value.trim();
    if (!contact) return alert("Enter email or phone number.");

    fetch(`${BACKEND_URL}/send-otp`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contact.includes("@") ? {email: contact} : {phone: contact})
    }).then(r => r.json()).then(d => {
        alert("OTP sent! Check your inbox or SMS.");
    }).catch(() => alert("Error sending OTP."));
}

function verifyOTP() {
    const otp = document.getElementById("otp").value.trim();
    const food = document.getElementById("food").value.trim();
    if (!otp || !food) return alert("Enter OTP and food history.");

    fetch(`${BACKEND_URL}/verify-otp`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            otp, food_history: food,
            ...(contact.includes("@") ? {email: contact} : {phone: contact})
        })
    }).then(r => r.json()).then(d => {
        document.getElementById("login").style.display = "none";
        document.getElementById("main").style.display = "block";
        document.getElementById("output").innerHTML = `Your Health Score: <b>${d.health_score}</b>/100`;

        if (d.health_score > 80) confetti();

        updateHistory(d.history);
    }).catch(() => alert("Invalid OTP or error. Try again."));
}

function ask() {
    const msg = document.getElementById("input").value.trim();
    if (!msg) return alert("Type something!");

    document.getElementById("output").innerHTML = "⏳ Loading...";
    fetch(`${BACKEND_URL}/ask`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: msg, type, email_or_phone: contact})
    }).then(r => r.json()).then(d => {
        document.getElementById("output").innerHTML = marked.parse(d.response);
        updateHistory(d.history);
    }).catch(() => document.getElementById("output").innerText = "Error fetching data.");
}

function updateHistory(hist) {
    const hDiv = document.getElementById("history");
    hDiv.innerHTML = "";
    hist.slice(-5).reverse().forEach(h => {
        const p = document.createElement("p");
        p.innerHTML = `${h.type === "medicine" ? "💊" : "🩺"} ${h.message}`;
        p.onclick = () => { document.getElementById("input").value = h.message; ask(); };
        hDiv.appendChild(p);
    });
}

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window)) return alert("Use Chrome or Safari for voice input.");
    const rec = new webkitSpeechRecognition();
    rec.lang = "en-IN";
    rec.onresult = e => {
        document.getElementById("input").value = e.results[0][0].transcript;
        ask();
    };
    rec.start();
}

function confetti() {
    confetti.create(undefined, {resize: true})({particleCount: 100, spread: 70});
}
</script>

</body>
</html>
